{{- if .Values.components.kyverno.enable -}}
{{- include "require.api.kyverno.clusterPolicy" . -}}
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: {{ default (include "platform-tenant.fullname" .) .Values.components.kyverno.name }}
  annotations:
    policies.kyverno.io/title: {{ default (include "platform-tenant.fullname" .) .Values.components.kyverno.name }} policy 
    policies.kyverno.io/category: Pod Scheduling
    policies.kyverno.io/description: >-
      Adds metadata to all jobs, deployments, daemons etc in the monitoring
      namespace.
spec:
  validationFailureAction: enforce
  rules:
    - name: add-metadata
      match:
        resources:
          kinds:
            - Job
            - DaemonSet
            - Deployment
            - StatefulSet
            - ReplicaSet
          namespaces:
            - {{ default (include "platform-tenant.fullname" .) .Values.targetNamespace.name }}
      mutate:
        patchStrategicMerge:
          metadata:
          {{- with .Values.components.kyverno.annotations }}
            annotations:
              {{- toYaml . | nindent 14 }}
          {{- end }}          
            labels:
              app.kubernetes.io/part-of: {{ (include "platform-tenant.fullname" .) | quote }}
              {{- with (omit .Values.components.kyverno.labels "app.kubernetes.io/part-of") }}
              {{- toYaml . | nindent 14 }}
              {{- end }}
          spec:
            template:
              {{- if or .Values.components.kyverno.nodeSelector .Values.components.kyverno.tolerations }}
              spec:
              {{- with .Values.components.kyverno.nodeSelector }}
                nodeSelector:
                  {{- toYaml . | nindent 18 }}
              {{- end }}
              {{- with .Values.components.kyverno.tolerations }}
                tolerations:
                  {{- toYaml . | nindent 18}}
              {{- end }}
              {{- else }}
              spec: {}
              {{- end }}
{{- end -}}